<!-- pages/settings/wxml (最终决战版 - 修复导航栏) -->

<custom-dialog 
  class="{{ pageClass }}"
  show="{{ showDeleteDialog }}"
  title="确认删除"
  message="确定要废弃此功法吗？"
  bind:confirm="onDeleteConfirm"
/>

<view class="page-wrapper {{ pageClass }}">
  <!-- 1. “大头部”容器 -->
  <view class="header-container">
    <view class="custom-nav" style="padding-top: {{ statusBarHeight }}px;">
      <view class="nav-title">功法阁</view>
    </view>
    
    <!-- 【核心修改】我们将完整的 van-tabs 结构（包含空的 van-tab）放在头部，用于生成导航栏 -->
    <van-tabs 
      active="{{ activeTab }}" 
      bind:change="onTabChange" 
      custom-class="header-tabs"
      nav-class="settings-tabs-nav"
      tab-class="settings-tab"
      tab-active-class="settings-tab-active"
    >
      <!-- 
        这个循环的唯一目的，就是告诉 van-tabs 需要渲染哪些导航标签。
        每个 van-tab 的内容都是空的，不会占用任何空间。
      -->
      <block wx:for="{{ userCultivations }}" wx:for-index="key" wx:key="key">
        <van-tab title="{{ categoryMap[key] }}" name="{{ key }}"></van-tab>
      </block>
    </van-tabs>
  </view>

  <!-- 2. “滚动区”容器 -->
  <view class="scroll-container">
    <!-- 我们在这里根据 activeTab 的值，只渲染对应的那一个内容面板 -->
    <block wx:for="{{ userCultivations }}" wx:for-index="key" wx:for-item="categoryItems" wx:key="key">
      <view class="tab-content" wx:if="{{ activeTab === key }}">
        <view class="container">
          <view class="gongfa-grid-container">
            
            <block wx:for="{{ categoryItems }}" wx:key="id">
              <view wx:if="{{ item.status !== 'archived' }}" class="gongfa-item" bind:tap="onEditGongfa" data-id="{{ item.id }}">
                <view class="delete-icon" catch:tap="onDeleteTap" data-category="{{ key }}" data-id="{{ item.id }}">
                  <van-icon name="cross" color="#aaa" />
                </view>
                <image class="gongfa-book-icon" src="/images/{{ categoryIconMap[key] }}" mode="aspectFit" />
                <view class="gongfa-item-name">{{ item.name }}</view>
                <view class="gongfa-item-exp">经验 +{{ item.exp }}</view>
              </view>
            </block>
            
            <view class="gongfa-item add-gongfa-btn" bind:tap="onAddNewGongfa">
              <van-icon name="add-o" size="48rpx" color="#aaa" />
              <view class="add-text">编入新功法</view>
            </view>
            
          </view>
        </view>
      </view>
    </block>
  </view>
</view>

<!-- Picker 弹出层 (保持不变) -->
<van-popup show="{{ showPickerPopup }}" position="bottom" bind:close="closeGongfaPickerPopup" round>
  <view class="picker-container {{ pageClass }}">
    <view class="picker-toolbar">
      <view class="picker-button cancel" bind:tap="closeGongfaPickerPopup">取消</view>
      <view class="picker-title">{{ isEditMode ? '修改功法' : '选择功法' }}</view>
      <view class="picker-button confirm" bind:tap="onPickerConfirm">
        {{ isEditMode ? '完成' : '确认' }}
      </view>
    </view>
    <picker-view 
      indicator-style="height: 50px;" 
      style="width: 100%; height: 260px;" 
      value="{{ pickerValue }}" 
      bindchange="onPickerChange"
    >
      <picker-view-column>
        <view wx:for="{{ pickerColumns.gongfaNames }}" wx:key="*this" class="picker-item">{{item}}</view>
      </picker-view-column>
      <picker-view-column>
        <view wx:for="{{ pickerColumns.durations }}" wx:key="*this" class="picker-item">{{item}}</view>
      </picker-view-column>
      <picker-view-column>
        <view wx:for="{{ pickerColumns.exps }}" wx:key="*this" class="picker-item readonly-item">{{item}}</view>
      </picker-view-column>
    </picker-view>
  </view>
</van-popup>
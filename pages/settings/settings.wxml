<!-- pages/settings/settings.wxml -->
<van-dialog 
  id="van-dialog"
  confirm-button-class="custom-confirm-button"
  cancel-button-class="custom-cancel-button"
/>

<view class="container">
  <van-tabs 
  active="{{ activeTab }}" 
  bind:change="onTabChange" 
  color="#4a90e2" 
  ellipsis="{{ false }}"
  line-animated="{{ false }}" 
>
    <block wx:for="{{ userCultivations }}" wx:for-index="key" wx:for-item="categoryItems" wx:key="key">
      <van-tab title="{{ categoryMap[key] }}" name="{{ key }}">
        <view class="gongfa-grid-container">
          
          <block wx:for="{{ categoryItems }}" wx:key="id">
            <view class="gongfa-item" bind:tap="onEditGongfa" data-id="{{ item.id }}">
              <view class="delete-icon" catch:tap="onDeleteTap" data-category="{{ key }}" data-id="{{ item.id }}">
                <van-icon name="cross" color="#aaa" />
              </view>
              <view class="gongfa-item-icon">
                <image class="gongfa-book-icon" src="/images/{{ categoryIconMap[key] }}" mode="aspectFit" />
              </view>
              <view class="gongfa-item-name">{{ item.name }}</view>
              <view class="gongfa-item-exp">经验 +{{ item.exp }}</view>
            </view>
          </block>

          <view class="gongfa-item add-gongfa-btn" bind:tap="onAddNewGongfa">
            <!-- 【核心修正】class. -> class= -->
            <view class="gongfa-item-icon">
              <van-icon name="add-o" size="32px" color="#aaa" />
            <!-- 【核心修正】</dview> -> </view> -->
            </view>
            <view class="gongfa-item-name add-text">编入新功法</view>
          </view>
        </view>
      </van-tab>
    </block>
  </van-tabs>
</view>

<!-- Picker 弹出层 -->
<van-popup show="{{ showPickerPopup }}" position="bottom" bind:close="closeGongfaPickerPopup" round>
  <view class="picker-container">
    <view class="picker-toolbar">
      <view class="picker-button cancel" bind:tap="closeGongfaPickerPopup">取消</view>
      <view class="picker-title">{{ isEditMode ? '修改功法' : '选择功法' }}</view>
      <view class="picker-button confirm" bind:tap="onPickerConfirm">
        {{ isEditMode ? '完成' : '确认' }}
      </view>
    </view>
    <picker-view 
      indicator-style="height: 50px;" 
      style="width: 100%; height: 260px;" 
      value="{{ pickerValue }}" 
      bindchange="onPickerChange"
    >
      <picker-view-column>
        <view wx:for="{{ pickerColumns.gongfaNames }}" wx:key="*this" class="picker-item">{{item}}</view>
      </picker-view-column>
      <picker-view-column>
        <view wx:for="{{ pickerColumns.durations }}" wx:key="*this" class="picker-item">{{item}}</view>
      </picker-view-column>
      <picker-view-column>
        <view wx:for="{{ pickerColumns.exps }}" wx:key="*this" class="picker-item readonly-item">{{item}}</view>
      </picker-view-column>
    </picker-view>
  </view>
</van-popup>